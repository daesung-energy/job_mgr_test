{% extends 'jobs/base.html' %}
{% load static %}
{% block content %}
<body>
    <wrap>
        <div id="JB109" style="padding-left: 50px; margin-top:50px;">
        <!-- 회기 선택 form -->
            <form action = "{% url 'JB109_1' %}" method="POST" id="JB109_1">
            {% csrf_token %}
            <!-- 회기 선택 박스 -->
            <div class="list-box-prd">
                <table id="prd">
                    <thead>
                        <tr>
                            <th style="width: 100px;">
                            <p>회 기</p>
                            </th>
                            <th>
                            <select name="prd_cd" class="select-combox3" id="selectOptions" onchange="this.form.submit()">
                            {% for item in prd_list %}
                            <option value="{{ item.prd_cd }}" {%if prd_cd_selected == item.prd_cd %} selected {% endif %}> {{ item.prd_cd }} ({{ item.year }}년 {{ item.turn }}차수) - 확정여부 : {{ item.prd_done_yn }} </option>
                            {% endfor %}
                            </select>
                            </th>
                        </tr>
                    </thead>
                </table>           
            </div>
            </form>

        <!-- 탭 선택에 따라 값을 다르게 하여 submit한다. 그 값은 view파일에서 어떤 탭인지 구분할 수 있는 key값(span)으로 쓰인다. -->
        <form action = "{% url 'JB109_2' %}" method="POST" id="JB109_2">
            {% csrf_token %}
            <input type="hidden" name="prd_cd_selected" value={{ prd_cd_selected }}>
            <div style="padding-left: 20px;">
                <span name="span1" onclick="submitForm('span1')" {% if tab == "tab1" %} class="Choice" {% endif %} style="cursor: pointer; font-family: Seed-Medium;">업무량 분석</span>
                <span style="padding-right: 40px"></span>
                <span name="span2" onclick="submitForm('span2')" {% if tab == "tab2" %} class="Choice" {% endif %} style="cursor: pointer; font-family: Seed-Medium;">업무량 구성비</span>
                <span style="padding-right: 40px"></span>
                <span name="span3" onclick="submitForm('span3')" {% if tab == "tab3" %} class="Choice" {% endif %} style="cursor: pointer; font-family: Seed-Medium;">적정인력 산정</span>
                <span style="padding-right: 40px"></span>
                <span name="span4" onclick="submitForm('span4')" {% if tab == "tab4" %} class="Choice" {% endif %} style="cursor: pointer; font-family: Seed-Medium;">인력산정 결과</span>
                <span style="padding-right: 40px"></span>
                <span name="span5" {% if tab == "span5" %} class="Choice" {% endif %} style="cursor: pointer; font-family: Seed-Medium;">연간 비교</span>
            </div>
        </form>

        <!-- 탭이 tab1 혹은 tab2일 때 부서 선택을 할 수 있도록 한다-->
        {% if tab == 'tab1' or tab == 'tab2' %}
        <!-- 부서 선택 div -->
        <div style="padding-top:20px;">
            
            <!-- 부서 선택 -->
            <p> 
                <!-- 부서 선택 form -->
                <form method="POST" id="JB109_3" action="{% url 'JB109_3' %}">
                {% csrf_token %}
                <!-- 회기, 탭 선택값 -->
                <input type="hidden" name="prd_cd_selected" value="{{ prd_cd_selected }}">
                <input type="hidden" name="tab" value="{{ tab }}">
                <span class="label-text2">부서</span>
                <!-- 선택/초기 회기에 대한 BsDept에 있는 목록을 가져옴, 선택한 값을 유지시켜 줌 if문 활용 -->
                <select name="dept_selected" class="select-combox" style="margin-left: 62px;" onchange="this.form.submit()">
                    {% if dept_selected_key == "former" %}
                    <option>부서선택</option>
                    {% endif %}
                    {% for item in dept_list %}
                    <option value="{{ item.dept_cd }}" {%if dept_selected == item.dept_cd %} selected {% endif %} > {{ item.dept_nm }} </option>
                    {% endfor %}
                </select>
                {% if dept_selected_key == "latter" %}
                <span style="margin-left: 795px;">
                    {% if tab == "tab1" %}
                    <button class="save" onclick="printTableContent('job_analysis', '{{ prd_cd_selected }}', '{{ dept_selected_nm }}')">인쇄</button>
                    <button class="save" onclick="exportToExcel('job_analysis')">다운로드</button>
                    {% endif %}
                    {% if tab == "tab2" %}
                    <button class="save" onclick="printTableContent('analysis_by_duty', '{{ prd_cd_selected }}', '{{ dept_selected_nm }}')">인쇄</button>
                    <button class="save" onclick="exportToExcel('analysis_by_duty')">다운로드</button>
                    {% endif %} 
                </span>
                {% else %}
                <span style="margin-left: 795px;">
                    <button class="del_disabled" disabled>인쇄</button>
                    <button class="del_disabled" disabled>다운로드</button> 
                </span>
                {% endif %}
            </form>
            </p>
        </div>
        {% endif %}

        <!-- 탭이 tab3, tab4일 경우 조직 그룹을 선택할 수 있도록 한다. -->
        {% if tab == 'tab3' or tab == 'tab4' %}
        <!-- 조직 그룹 선택 div -->
        <div style="padding-top:20px;">
            
            <!-- 부서 선택 -->
            <p> 
                <!-- 부서 선택 form -->
                <form method="POST" id="JB109_4" action="{% url 'JB109_4' %}">
                {% csrf_token %}
                <!-- 회기, 탭 선택값 -->
                <input type="hidden" name="prd_cd_selected" value="{{ prd_cd_selected }}">
                <input type="hidden" name="tab" value="{{ tab }}">
                <span class="label-text2">조직그룹</span>
                <!-- 선택/초기 회기에 대한 BsDept에 있는 목록을 가져옴, 선택한 값을 유지시켜 줌 if문 활용 -->
                <select name="domain_selected" class="select-combox" style="margin-left: 40px;" onchange="this.form.submit()">
                    {% if domain_selected_key == "former" %}
                    <option>조직그룹 선택</option>
                    {% endif %}
                    {% for item in domain_list %}
                    <option value="{{ item }}" {%if domain_selected == item %} selected {% endif %} > {{ item }} </option>
                    {% endfor %}
                </select>
                {% if domain_selected_key == "latter" %}
                    {% if tab == 'tab3' %}
                        <span style="margin-left: 795px;">
                            <button class="save" onclick="printTableContent('man_analysis', '{{ prd_cd_selected }}', '{{ domain_selected }}')">인쇄</button>
                            <button class="save" onclick="exportToExcel('man_analysis')">다운로드</button>
                        </span>
                    {% endif %}
                {% else %}
                <span style="margin-left: 795px;">
                    <button class="del_disabled" disabled>인쇄</button>
                    <button class="del_disabled" disabled>다운로드</button> 
                </span>
                {% endif %}
            </form>
            </p>
        </div>
        {% endif %}

        <!-- 탭 선택에 따라 다르게 보여줌 -->
        <!-- 1. 업무량 분석 탭 -->
        {% if tab == 'tab1' %}
            {% if dept_selected_key == "latter" %}
            <div style="margin-top:20px; margin-bottom:20px; margin-left:1035px; background-color: yellow;">
                
            </div>
            <!-- 업무량 분석 div -->
            <div id="JB109_3" style="width:1300px;">
                <span style="padding-left:1185px;">
                    <label style="background-color: ivory; font-family: Seed-Medium; font-size: 20px;  border: 1px solid #1c7293;
                    border-radius: 1px; border-color: black; padding: 15px;">{{ overless }}</label>
                </span>
                <div id="업무량분석" class="list-box">
                    <table id="job_analysis">
                    <thead>                
                        <tr>
                            <th colspan=4><p>업무량 분석 결과</p></th>
                            <th colspan=3><p>환산 PO 계산</p></th>
                            <th colspan=2><p>적정 인력 산정(※ G3 기준 환산)</th>
                            <th rowspan=2><p>과부족 여부</p><p>(ⓒ=ⓐ-ⓑ)</p></th>
                        </tr>
                        <tr>
                            <th><p>업무등급</p></th>
                            <th><p>과업수</p></th>
                            <th><p>연간 업무량</p></th>
                            <th><p>인력 산정</p></th>
                            <th><p>PO</p></th>
                            <th><p>업무량 가중치</p></th>
                            <th><p>환산PO(ⓐ)</p></th>
                            <th><p>환산 업무량</p></th>
                            <th><p>적정 인력 산정</p><p>(ⓑ)</p></th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for index, row in analysis.iterrows %}
                    <tr style="height: 50px; text-align: center;">
                    <td><p>{{ row.work_grade }}</p></td>
                    <td><p>{{ row.task_count }}</p></td>
                    <td class="number-format"><p>{{ row.prfrm_tm_ann }}</p></td>
                    <td><p>{{ row.po_result }}</p></td>
                    <td><p>{{ row.po }}</p></td>
                    <td><p>{{ row.workload_wt }}</p></td>
                    <td style="background-color: rgba(235, 238, 177, 0.984);"><p>{{ row.po_cal }}</p></td>
                    <td class="number-format"><p>{{ row.prfrm_tm_ann_cal }}</p></td>
                    <td style="background-color: rgb(177, 211, 225);"><p>{{ row.po_right }}</p></td>
                    <td><p>{{ row.overless }}</p></td>
                    </tr>
                    {% endfor %}
                    <tr style="height: 50px;">
                    <td style="text-align: center;"><p>합계</p></td>
                    <td style="text-align: center;"><p> {{ sum_1 }}</p></td>
                    <td class="number-format" style="text-align: center;"><p> {{ sum_2 }}</p></td>
                    <td style="text-align: center;"><p> {{ sum_3 }}</p></td>
                    <td style="text-align: center;"><p> {{ sum_4 }}</p></td>
                    <td style="text-align: center;"><p> </p></td>
                    <td style="text-align: center;"><p> {{ sum_5 }}</p></td>
                    <td class="number-format" style="text-align: center;"><p> {{ sum_6 }}</p></td>
                    <td style="text-align: center;"><p> {{ sum_7 }}</p></td>
                    <td style="text-align: center;"><p> {{ sum_8 }}</p></td>
                    </tr>
                    </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        {% endif %}

        <!-- 2. 업무량 구성비 탭 -->

        {% if tab == 'tab2' %}
            {% if dept_selected_key == "latter" %}

            <div style="margin-top:20px; margin-left:20px; border: 1px solid #ccc; overflow-y: scroll; height: 600px; width:1320px;">        
            <div id="analysis" class="list-box" style="padding-top:20px; width:1300px;" >
                <table id="analysis_by_duty">
                    <thead>                
                        <tr>
                            <th style="height: 40px;"><p>직무명</p></th>
                            <th style="height: 40px;"><p>책무명</p></th>
                            <th style="height: 40px;"><p>과업수</p></th>
                            <th style="height: 40px;"><p>연간 수행시간</p></th>
                            <th style="height: 40px;"><p>업무량 구성비(%)</p></th>
                            <th style="height: 40px;"><p>중요도</p></th>
                            <th style="height: 40px;"><p>난이도</p></th>                           
                            <th style="height: 40px;"><p>숙련도</p></th>
                            <th style="height: 40px;"><p>업무 등급</p></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for index, row in analysis.iterrows %}
                            <tr style="height: 40px; text-align: center;">
                                <td class="job-cell-class"><p>{{ row.job_nm }}</p></td>
                                <td><p>{{ row.duty_nm }}</p></td>
                                <td><p>{{ row.task_cnt }}</p></td>
                                <td><p>{{ row.duty_tm_ann }}</p></td>
                                <td><p>{{ row.duty_ratio }}</p></td>
                                <td><p>{{ row.duty_imprt }}</p></td>
                                <td><p>{{ row.duty_dfclt }}</p></td>
                                <td><p>{{ row.duty_prfcn }}</p></td>
                                <td><p>{{ row.work_lv_mean }}</p></td>
                            </tr>
                        {% endfor %}
                        <tr style="height: 40px; text-align: center;">
                            <td colspan="3"><p>합계</p></td>
                            <td><p>{{ sum_duty_tm_ann }}</p></td>
                            <td><p>{{ sum_duty_ratio }}</p></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>                            
                        </tr>
                    </tbody>
                </table>
            </div>
            {% endif %}
        {% endif %}

        <!-- 3. 적정인력 산정 탭 -->
        {% if tab == 'tab3' %}
            {% if domain_selected_key == "latter" %}
            <div style="margin-top:20px; margin-left:20px; border: 1px solid #ccc; overflow-y: scroll; height: 600px; width:1320px;">
            <div id="analysis" class="list-box" style="padding-top:20px; width:1300px;">
                <table id="man_analysis">
                    <thead>                
                        <tr>
                            <th colspan=2><p>{{ domain_selected }}</p></th>
                            <th><p>PO</p></th>
                            <th colspan=2><p>업무량 분석 결과</p></th>
                            <th colspan=4><p>적정인력 산정 결과</p></th>
                        </tr>
                        <tr>
                            <th><p>그룹명</p></th>
                            <th><p>부서명</p></th>
                            <th><p>팀장 제외</p></th>
                            <th><p>연간 업무량</p></th>
                            <th><p>소요 인원</p></th>
                            <th><p>환산 업무량</p></th>
                            <th><p>환산 PO</p></th>
                            <th><p>적정 인력 산정</p></th>
                            <th><p>과부족</p></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for index, row in analysis.iterrows %}
                            <tr style="height: 40px; text-align: center;">
                                <td class="dept-grp-cell-class"><p>{{ row.dept_grp_nm }}</p></td>
                                <td><p>{{ row.dept_nm }}</p></td>
                                <td><p>{{ row.dept_po }}</p></td>
                                <td><p>{{ row.prfrm_tm_ann }}</p></td>
                                <td><p>{{ row.po_nec }}</p></td>
                                <td><p>{{ row.tm_cal }}</p></td>
                                <td><p>{{ row.po_cal }}</p></td>
                                <td><p>{{ row.po_appr }}</p></td>
                                <td><p>{{ row.overless }}</p></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            </div>
            {% endif %}
        {% endif %}

        <!-- 4. 인력산정 결과 탭 -->
        {% if tab == 'tab3' %}
            {% if domain_selected_key == "latter" %}
            
            

            {% endif %}
        {% endif %}

        <input type="hidden" id="tab-value" value="{{ tab }}">

    </div>
    </wrap>
    
    <script>

        //프린트
        function printTableContent(tableId, prdCdSelected, deptSelectedNm) {

            // 테이블 요소 가져오기
            var table = document.getElementById(tableId);

            // 테이블이 없으면 경고 후 리턴
            if (!table) {
                alert("인쇄할 자료가 없습니다");
                    return;
                }
            
            var content = table.outerHTML; // 테이블 요소의 HTML 내용을 가져와 content에 저장
            var originalDocument = document.body.innerHTML; // 원래 문서 내용을 originalDocument에 저장

            // 프린트 내용에 추가할 내용
            var printContent = `
                <div>
                    <p>회기: ${prdCdSelected}</p>
                    <p>부서: ${deptSelectedNm}</p>
                </div>
                ${content}
            `;

            // 문서 내용을 프린트 내용으로 변경
            document.body.innerHTML = printContent;

            // 프린트 대화 상자 열기
            window.print();

            // 원래 문서 내용으로 복원
            document.body.innerHTML = originalDocument;
        }

        //-----------------엑셀로 저장-----------------
        // 행사이즈 조절
        function autoSizeColumns(worksheet) {

            //각 행 마다 가장 긴 글자 수를 기준으로 각 열 넓이 자동 조정
            worksheet.columns.forEach((column, columnIndex) => {
                let maxColumnLength = 0;
                column.eachCell({ includeEmpty: true }, cell => {
                    const cellValue = cell.value ? cell.value.toString() : '';
                    let cellLength = 0;

                    // 각 문자에 대해 길이 측정
                    for (let char of cellValue) {
                        if (char.match(/[\uac00-\ud7a3]/)) { // 한글과 같은 폭이 넓은 문자 처리
                            cellLength += 2;
                        } else if (char.match(/[\u0020-\u007E]/)) { // 기본 ASCII 문자
                            cellLength += 1;
                        } else {
                            cellLength += 1.5; // 그 외 다른 문자 (일반적으로 넓은 문자)
                        }
                    }

                    // 현재 셀의 길이가 저장된 최대 길이보다 크다면 업데이트
                    if (cellLength * 2 > maxColumnLength) {
                        maxColumnLength = cellLength * 2;
                    }
                    // 열의 너비를 최대 길이에 따라 설정, 최소 너비는 10으로 설정
                    column.width = maxColumnLength < 10 ? 10 : maxColumnLength + 2; // 약간의 여유 공간 추가
                });
            });
        }

        function exportToExcel(tableId) {
            const fileName = prompt('파일 이름을 입력하세요.');
            if (fileName === null || fileName.trim() === '') {
                alert('파일 이름을 입력하세요.');
                return;
            }

            const table = document.getElementById(tableId);
            if (!table) {
                alert("Table not found!");
                return;
            }

            const prd_cd_selected = document.querySelector("input[name='prd_cd_selected']").value; // 회기를 직접 가져오기
            const tabValue = document.getElementById('tab-value').value;

            // const dept_selected = document.querySelector("select[name='dept_selected']").selectedOptions[0].text;  // 부서명을 직접 가져오기

            let selectedInfo;
            if (tabValue === 'tab3') {
                selectedInfo = document.querySelector("select[name='domain_selected']").selectedOptions[0].text; // 도메인명을 직접 가져오기
            } else {
                selectedInfo = document.querySelector("select[name='dept_selected']").selectedOptions[0].text;  // 부서명을 직접 가져오기
            }
            
            const workbook = new ExcelJS.Workbook(); // ExcelJS workbook 생성
            const worksheet = workbook.addWorksheet('Sheet 1'); // 시트 생성

            const headerRow = worksheet.getRow(1); // 첫 번째 행에 헤더 추가
            headerRow.getCell(1).value = "회기: " + prd_cd_selected; // 회기 정보 추가
            // headerRow.getCell(2).value = "부서: " + dept_selected; // 부서 정보 추가
            headerRow.getCell(2).value = tabValue === 'tab3' ? "도메인: " + selectedInfo : "부서: " + selectedInfo; // 도메인 또는 부서 정보 추가

            headerRow.commit(); // 행에 대한 변경 사항을 저장

            let currentExcelRow = 3; // 엑셀 행 인덱스. 3번째 행부터 내용을 넣을 것이다.
            let mergeMap = []; // 엑셀 셀 병합 정보를 저장할 배열

            // console.log(table.rows); 

            if (tabValue === 'tab1') { // 업무량 분석 탭

                // 콘솔에 프린트
                // console.log(table.rows);

                Array.from(table.rows).forEach((htmlRow, rowIndex) => { // 테이블의 각 행에 대해 반복. Array.from()을 사용하여 유사 배열 객체를 배열로 변환. 각 행 내에서 각 index에 대한 정보를 가져옴
                    const excelRow = worksheet.getRow(currentExcelRow); // 엑셀 행 생성. excelRow라는 변수에 현재 행을 받아옴
                    let currentExcelColumn = 1; // 엑셀 열 인덱스. 1번째 열부터 내용을 넣을 것이다. 1열부터 시작.

                    Array.from(htmlRow.cells).forEach(htmlCell => { // 테이블의 행 내에서 각 셀에 대해 반복
                        while (mergeMap[currentExcelColumn] > currentExcelRow) { // 현재 열이 병합된 셀이라면
                            currentExcelColumn++; // 다음 열로 이동
                        }

                        const excelCell = excelRow.getCell(currentExcelColumn); // 엑셀 셀 생성
                        excelCell.value = htmlCell.innerText; // 엑셀 셀에 HTML 셀의 텍스트 내용을 입력
                        applyStylesToCell(excelCell, htmlCell); // 엑셀 셀에 스타일 적용

                        const colSpan = htmlCell.colSpan || 1; // 셀의 열 병합 수. 없으면 1로 설정
                        const rowSpan = htmlCell.rowSpan || 1; // 셀의 행 병합 수. 없으면 1로 설정

                        if (colSpan > 1 || rowSpan > 1) { // 병합이 필요한 경우
                            let mergeEndColumn = currentExcelColumn + colSpan - 1; // 병합할 마지막 열은 시작 열 + 병합 수 - 1
                            let mergeEndRow = currentExcelRow + rowSpan - 1; // 병합할 마지막 행은 시작 행 + 병합 수 - 1
                            worksheet.mergeCells(currentExcelRow, currentExcelColumn, mergeEndRow, mergeEndColumn); // mergeCells함수를 사용하여 병합. 인자는 시작 행, 시작 열, 끝 행, 끝 열

                            for (let col = currentExcelColumn; col <= mergeEndColumn; col++) { // 병합된 열에 대해 반복
                                mergeMap[col] = mergeEndRow; // 병합된 열에 대해 병합된 행 정보를 저장
                            }
                        }
                        currentExcelColumn += colSpan; // 현재 열을 병합된 열의 다음 열로 이동
                    });
                    currentExcelRow++; // 다음 행으로 이동
                });
            }

            if (tabValue === 'tab2') { // 업무량 구성비 탭
                let currentExcelRow = 3;
                Array.from(table.rows).forEach((htmlRow) => {
                    const excelRow = worksheet.getRow(currentExcelRow);
                    let currentExcelColumn = 1;

                    Array.from(htmlRow.cells).forEach(htmlCell => {
                        const excelCell = excelRow.getCell(currentExcelColumn);
                        excelCell.value = htmlCell.innerText;
                        applyStylesToCell(excelCell, htmlCell);

                        const colSpan = htmlCell.colSpan || 1;
                        const rowSpan = htmlCell.rowSpan || 1;

                        if (colSpan > 1 || rowSpan > 1) {
                            let mergeEndColumn = currentExcelColumn + colSpan - 1;
                            let mergeEndRow = currentExcelRow + rowSpan - 1;
                            worksheet.mergeCells(currentExcelRow, currentExcelColumn, mergeEndRow, mergeEndColumn);
                        }
                        currentExcelColumn += colSpan;
                    });
                    currentExcelRow++;
                });
            }

            if (tabValue === 'tab3') {
                let currentExcelRow = 3;
                Array.from(table.rows).forEach((htmlRow) => {
                    const excelRow = worksheet.getRow(currentExcelRow);
                    let currentExcelColumn = 1;

                    Array.from(htmlRow.cells).forEach(htmlCell => {
                        const excelCell = excelRow.getCell(currentExcelColumn);
                        excelCell.value = htmlCell.innerText;
                        applyStylesToCell(excelCell, htmlCell);

                        const colSpan = htmlCell.colSpan || 1;
                        const rowSpan = htmlCell.rowSpan || 1;

                        if (colSpan > 1 || rowSpan > 1) {
                            let mergeEndColumn = currentExcelColumn + colSpan - 1;
                            let mergeEndRow = currentExcelRow + rowSpan - 1;
                            worksheet.mergeCells(currentExcelRow, currentExcelColumn, mergeEndRow, mergeEndColumn);
                        }
                        currentExcelColumn += colSpan;
                    });
                    currentExcelRow++;
                });
            }

            worksheet.columns.forEach(column => { // 각 열에 대해 반복
                column.width = 20; // 각 열의 너비를 20으로 설정
            });

            workbook.xlsx.writeBuffer().then(function(buffer) { // 엑셀 파일을 버퍼로 변환. 버퍼란 메모리의 일부를 가리키는 포인터
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }); // 버퍼를 Blob으로 변환.
                const url = window.URL.createObjectURL(blob); // Blob을 URL로 변환

                const confirmation = confirm(`파일 이름: ${fileName}.xlsx \n파일을 다운로드하시겠습니까?`); // 다운로드 여부 확인
                if (confirmation) { // 확인 버튼을 누르면
                    const anchor = document.createElement('a'); // a 태그 생성
                    anchor.href = url; // a 태그의 href 속성에 URL 설정. url은 위에서 생성한 Blob URL
                    anchor.download = fileName + '.xlsx'; // 다운로드될 파일 이름 설정
                    anchor.click(); // a 태그 클릭. 클릭하면 다운로드가 시작됨
                    window.URL.revokeObjectURL(url); // URL 해제
                }
            }).catch(error => { // 오류 발생 시
                console.error('Error writing excel file', error); // 콘솔에 오류 메시지 출력
                alert('다운로드 오류가 발생했습니다.'); // 사용자에게 오류 메시지 출력
            });
        }

        function applyStylesToCell(excelCell, htmlElement) {
            const cssStyle = window.getComputedStyle(htmlElement);
            excelCell.style = {
                font: {
                    bold: cssStyle.fontWeight === 'bold' || parseInt(cssStyle.fontWeight) >= 600,
                    color: { argb: colorToArgb(cssStyle.color) }
                },
                fill: {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: colorToArgb(cssStyle.backgroundColor) }
                },
                alignment: {
                    horizontal: cssStyle.textAlign,
                    vertical: 'middle'
                },
                border: {
                    top: { style: 'thin', color: { argb: 'FF000000' } },
                    left: { style: 'thin', color: { argb: 'FF000000' } },
                    bottom: { style: 'thin', color: { argb: 'FF000000' } },
                    right: { style: 'thin', color: { argb: 'FF000000' } }
                }
            };
        }

        function colorToArgb(color) {
            if (!color || color === 'transparent' || color.includes('rgba(0, 0, 0, 0)')) {
                return 'FFFFFFFF'; // Use white for fully transparent colors
            }

            const rgba = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([0-9.]+))?\)/);
            if (rgba) {
                const r = parseInt(rgba[1]).toString(16).padStart(2, '0');
                const g = parseInt(rgba[2]).toString(16).padStart(2, '0');
                const b = parseInt(rgba[3]).toString(16).padStart(2, '0');
                const a = rgba[4] ? Math.round(parseFloat(rgba[4]) * 255).toString(16).padStart(2, '0') : 'FF';
                if (a === '00') {
                    return 'FFFFFFFF'; // Convert fully transparent to white
                }
                return a + r + g + b; // ARGB
            } else {
                // Handle named colors and hex colors
                const canvas = document.createElement("canvas");
                canvas.height = 1;
                canvas.width = 1;
                const ctx = canvas.getContext("2d");
                ctx.fillStyle = color;
                ctx.fillRect(0, 0, 1, 1);
                const [r, g, b, a] = ctx.getImageData(0, 0, 1, 1).data;
                if (a === 0) {
                    return 'FFFFFFFF'; // Convert fully transparent to white
                }
                return `FF${[r, g, b].map(x => x.toString(16).padStart(2, '0')).join('')}`;
            }
        }

        window.addEventListener('load', function() {
            // 모든 'number-format' 클래스를 가진 요소 찾기
            const numberElements = document.querySelectorAll('.number-format p');

            const tabValue = document.getElementById('tab-value').value;

            // 각 요소에 대해 숫자 형식 변경
            numberElements.forEach(element => {
                // 요소의 텍스트를 float으로 변환하고, 로케일 문자열로 포맷
                const formattedNumber = parseFloat(element.innerText).toLocaleString('en-US', {
                    minimumFractionDigits: 1, // 최소 소수점 자릿수
                    maximumFractionDigits: 1  // 최대 소수점 자릿수
                });
                element.innerText = formattedNumber;
            });

            // 분석 테이블의 모든 셀 가져옴
            const tableCells = document.querySelectorAll('#analysis_by_duty td p');

            // 0인 데이터 처리.
            tableCells.forEach(cell => {
                // 부모 행에서 "직무" 정보를 확인
                const row = cell.closest('tr');
                const jobCell = row.querySelector('td.job-cell-class'); // "직무" 셀을 찾음

                // "직무" 셀이 "팀리더"인 경우에만 빈 문자열로 설정
                if (jobCell && jobCell.innerText.trim() === "팀리더") {
                    if (cell.innerText.trim() === "0.0" || cell.innerText.trim() === "0") {
                        cell.innerText = "";
                    }
                }
            });

            // // // 직무명이 같은 경우 셀 병합
            // if (tabValue === 'tab2') {

            //     const table = document.getElementById('analysis_by_duty');

            //     let previousJobName = "";
            //     let rowspanCount = 1;
            //     let firstCell;

            //     // if (tabValue === 'tab2') {
            //     for (let row of table.rows) {
            //         let currentCell = row.cells[0];

            //         if (currentCell.innerText === previousJobName) {
            //             rowspanCount++;
            //             firstCell.rowSpan = rowspanCount;
            //             currentCell.style.display = 'none';
            //         } else {
            //             previousJobName = currentCell.innerText;
            //             firstCell = currentCell;
            //             rowspanCount = 1;
            //         }
            //     }
            // }

            // // tab3의 man_analysis 테이블을 위한 rowspan 처리
            // if (tabValue === 'tab3') {
            //     const table = document.getElementById('man_analysis');

            //     let previousDeptGrpName = "";
            //     let rowspanCount = 1;
            //     let firstCell;

            //     for (let row of table.rows) {
            //         let currentCell = row.cells[0];

            //         if (currentCell.innerText === previousDeptGrpName) {
            //             rowspanCount++;
            //             firstCell.rowSpan = rowspanCount;
            //             currentCell.style.display = 'none';
            //         } else {
            //             previousDeptGrpName = currentCell.innerText;
            //             firstCell = currentCell;
            //             rowspanCount = 1;
            //         }
            //     }
            // }
            
            function mergeCellsByColumn(tableId, columnIndex) {
                const table = document.getElementById(tableId);

                if (!table) {
                    return;
                }

                let previousText = "";
                let rowspanCount = 1;
                let firstCell;

                for (let row of table.rows) {
                    let currentCell = row.cells[columnIndex];

                    if (currentCell.innerText === previousText) {
                        rowspanCount++;
                        firstCell.rowSpan = rowspanCount;
                        currentCell.style.display = 'none';
                    } else {
                        previousText = currentCell.innerText;
                        firstCell = currentCell;
                        rowspanCount = 1;
                    }
                }
            }

            // const tabValue = document.getElementById('tab-value').value;

            if (tabValue === 'tab2') {
                mergeCellsByColumn('analysis_by_duty', 0); // 직무명 컬럼 인덱스 0
            }

            if (tabValue === 'tab3') {
                mergeCellsByColumn('man_analysis', 0); // 그룹명 컬럼 인덱스 0
            }
        });

        function submitForm(spanName) { // submit하는 폼
            var form = document.getElementById("JB109_2");

            var input = document.createElement("input");
            input.type = "hidden";
            input.name = "span_name";
            input.value = spanName;
            form.appendChild(input);

            form.submit();
        }

    </script>

</body>

{% endblock %}