{% extends 'jobs/base.html' %}
{% load static %}
{% block content %}
<body>
    <wrap>
        <!-- 전체 div -->
        <div id = "JB110" style="margin-left: 50px; margin-top:50px;">
        
            <!-- 회기와 탭 선택을 하면 1차 submit한다. submit하면 해당 회기 및 탭에 대한 정보를 띄운다. -->
            <!-- 회기 선택 div -->
            <div>
            <form id="JB110_0" action="{% url 'JB110' %}" method="POST">
                {% csrf_token %}

                <!-- 회기 선택 박스 -->
                <div class="list-box-prd">
                <table>
                    <thead>
                    <tr>
                        <th style="width: 100px;">
                        <p>회 기</p>
                        </th>
                        <th>
                        <select name="prd_cd_selected" class="select-combox3" id="selectOptions" onchange="this.form.submit()">
                        {% for item in prd_list %}
                        <option value="{{ item.prd_cd }}" {%if prd_cd_selected == item.prd_cd %} selected {% endif %}> {{ item.prd_cd }} - 확정여부 : {{ item.prd_done_yn }} </option>
                        {% endfor %}
                        </select>
                        </th>
                    </tr>
                    </thead>
                </table>           
                </div>
            </form>
            </div>

            <!-- 탭 선택 div -->
            <div>
            <form id="JB110_1" action="{% url 'JB110_1' %}" method="POST">
                {% csrf_token %}

                <input type="hidden" name="prd_cd_selected" value= {{ prd_cd_selected }}>

                <!-- 탭 선택에 따라 값을 다르게 하여 submit한다. 그 값은 view파일에서 어떤 탭인지 구분할 수 있는 key값(span)으로 쓰인다. -->
                <div style="padding-left: 20px;">
                <span name="span1" onclick="submitForm('span1')" {% if tab == "tab1" %} class="Choice" {% endif %}l style="cursor: pointer; font-family: Seed-Medium;">직무별 업무량 분석</span>
                <span style="padding-right: 40px"></span>
                <span name="span2" style="cursor: pointer; font-family: Seed-Medium;">담당자별 업무량 분석</span>
                </div>
            </form>
            </div>

            <!-- 부서 선택 div -->
            <div style="padding-top: 20px;">
                <!-- 부서 선택 form -->
                <form id="JB110_2" action="{% url 'JB110_2' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="prd_cd_selected" value= {{ prd_cd_selected }}>
                    <input type="hidden" name="tab" value= {{ tab }}>
                    
                    <p class="label-text2"> 부서
                    <!-- 부서 정보들을 모두 표시하고 onchange되면 submit 해서 해당 부서(display_dept)원들을 불러옴 -->
                    <select class="select-combox" name="dept_selected" onchange="this.form.submit()" style="margin-left: 62px;">
                        {% if status == 'tab_before' %}
                            <option> {{ dept_login_nm}} </option>
                        {% else %}
                        {% for item in dept_list %}
                            <option value={{ item.dept_cd }} {%if dept_selected == item.dept_cd %} selected {% endif %}> {{ item.dept_nm }} </option>
                        {% endfor %}
                        {% endif %}
                    </select>
                    </p>
                </form>
            </div>

            {% if tab == "tab1" %}
            <!-- 직무별 업무량 분석 테이블 div - 탭이 직무별 업무량 분석일 때만 떠야 함 -->            
            <div id="analysis" class="list-box" style="padding-top:20px; width:1300px;" >
                <table id="analysis_by_jobs">
                <thead>                
                    <tr>
                        <th rowspan=2><p>직무명</p></th>
                        <th rowspan=2><p>과업수</p></th>
                        <th rowspan=2><p>연간 수행시간</p></th>
                        <th rowspan=2><p>구성비(%)</p></th>
                        <th colspan=5><p>업무 수준</p></th>
                    </tr>
                    <tr>
                        <th><p>중요도</p></th>
                        <th><p>난이도</p></th>
                        <th><p>숙련도</p></th>
                        <th><p>업무수준</p></th>
                        <th><p>업무등급</p></th>
                    </tr>
                </thead>
                <tbody>
                <!-- 일반 행 - for문으로 생성, analysis라는 dataframe을 참조 -->
                {% for index, row in analysis.iterrows %}
                <tr style="height: 50px; text-align: center;">
                    <td style="line-height: 1;"><p>{{ row.job_nm }}</p></td>
                    <td><p>{{ row.cnt_task }}</p></td>
                    <td class="number-format"><p>{{ row.wrk_tm }}</p></td>
                    <td><p>{% if row.wrk_ratio1 %} {{ row.wrk_ratio1 }}% {% else %} {% endif %}</p></td>
                    <td><p>{{ row.imprt }}</p></td>
                    <td><p>{{ row.dfclt }}</p></td>
                    <td><p>{{ row.prfcn }}</p></td>
                    <td><p>{{ row.wrk_lv_sum }}</p></td>
                    <td><p>{{ row.work_grade }}</p></td>
                </tr>
                {% endfor %}
                <!-- 합계 행 -->
                <tr style="height: 50px;">
                    <td style="text-align: center;"><p>합계</p></td>
                    <td style="text-align: center;"><p> {{ sum_1 }}</p></td>
                    <td class="number-format" style="text-align: center;"><p> {{ sum_2 }}</p></td>
                    <td style="text-align: center;"><p> {{ sum_3 }}%</p></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                </tbody>
                </table>
            </div>
            {% endif %}


        </div>

    </wrap>
    
    <script>
        function submitForm(spanName) { // submit하는 폼
            // 폼을 가져옵니다.
            var form = document.getElementById("JB110_1");

            // 추가 작업이 필요하다면 여기에서 수행합니다.

            // spanName을 폼에 추가하거나 다른 처리를 수행할 수 있습니다.
            var input = document.createElement("input");
            input.type = "hidden";
            input.name = "span_name";
            input.value = spanName;
            form.appendChild(input);

            // 폼을 제출합니다.
            form.submit();
        }

        window.addEventListener('load', function() {
            // 모든 'number-format' 클래스를 가진 요소 찾기
            const numberElements = document.querySelectorAll('.number-format p');

            // 각 요소에 대해 숫자 형식 변경
            numberElements.forEach(element => {
                // 요소의 텍스트를 float으로 변환하고, 로케일 문자열로 포맷
                const formattedNumber = parseFloat(element.innerText).toLocaleString('en-US', {
                    minimumFractionDigits: 1, // 최소 소수점 자릿수
                    maximumFractionDigits: 1  // 최대 소수점 자릿수
                });
                element.innerText = formattedNumber;
            });

            // Nan인 경우 빈칸으로 변경
            numberElements.forEach(element => {
                if (element.innerText === 'NaN') {
                    element.innerText = '';
                }
            });
        });

    </script>


</body>
{% endblock %}
